<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Properties expected to be provided, unless these defaults are OK -->
  <PropertyGroup>
    <PackageName Condition="$(PackageName) == ''"></PackageName>
    <SevenZipDirectory Condition="$(SevenZipDirectory) == ''">$(MSBuildProjectDirectory)\Dependencies\7-zip</SevenZipDirectory>
    <PackageDirectory Condition="$(PackageDirectory) == ''">package</PackageDirectory>
    <SfxDirectory Condition="$(SfxDirectory) == ''">$(MSBuildProjectDirectory)\sfx</SfxDirectory>
  </PropertyGroup>

  <ItemGroup>
    <DeployExe Condition="@(DeployExe) == ''" Include="$(MSBuildProjectDirectory)\Dependencies\CM.NET\deployer.exe" />
  </ItemGroup>
  
  <PropertyGroup>
    <CleanTargets>$(CleanTargets);CleanPackageDirectory</CleanTargets>
    <PostCleanTargets>$(PostCleanTargets);CreatePackageDirectory</PostCleanTargets>
    <PackageTargets>$(PackageTargets);CreateSfx</PackageTargets>
    <TraceDataTargets>$(TraceDataTargets);TraceSfxData</TraceDataTargets>
  </PropertyGroup>

  <Target Name="CleanPackageDirectory">
    <RemoveDir Directories="$(PackageDirectory)" Condition="Exists('$(PackageDirectory)')" />
  </Target>
  
  <Target Name="CreatePackageDirectory">
    <MakeDir Directories="$(PackageDirectory)" Condition="!Exists('$(PackageDirectory)')" />
  </Target>
  
  <Target Name="CreateSfx">
    <Error Text="No PackageName property was defined" Condition="$(PackageName) == ''" />
    <Copy SourceFiles="@(DeployExe)" DestinationFolder="$(PackageDirectory)" />
    <Copy SourceFiles="$(SevenZipDirectory)\7zS.sfx" DestinationFolder="$(SfxDirectory)" />
    
    <PropertyGroup>
      <SevenZipConfig>
%3B!@Install@!UTF-8!
Title="Deploy"
RunProgram="$(PackageDirectory)\@(DeployExe->'%(Filename)').exe"
%3B!@InstallEnd@!
      </SevenZipConfig>
    </PropertyGroup>
    
    <Exec Command="$(SevenZipDirectory)\7z.exe a $(SfxDirectory)\package.7z $(PackageDirectory)" />
    <WriteLinesToFile File="$(SfxDirectory)\config.txt" Lines="$(SevenZipConfig)" />
    <Exec Command="copy /b 7zS.sfx + config.txt + package.7z $(PackageName).exe" 
      WorkingDirectory="$(SfxDirectory)" />
  </Target>

  <Target Name="TraceSfxData">
    <Message Text="Sfx.targets" />
    <Message Text="  PackageName: $(PackageName)" />
    <Message Text="  SevenZipDirectory: $(SevenZipDirectory)" />
    <Message Text="  PackageDirectory: $(PackageDirectory)" />
    <Message Text="  SfxDirectory: $(SfxDirectory)" />
  </Target>
</Project>
